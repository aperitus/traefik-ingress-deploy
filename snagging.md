# Snagging Log — Traefik Ingress Repo (Chat Summary)

This table collates the issues addressed per version during the iterative build of the **Traefik ingress** repo/workflow.  
Assumption applied: **if an error was not re-entered after a change, it is treated as corrected.**

| Version | Primary issue(s) observed | Error / symptom (as seen) | Fix / change applied | Outcome / notes |
|---:|---|---|---|---|
| v1–v3 | Strategy + repo split | N/A (design change) | Switched from ingress-nginx to **Traefik**; separated “Traefik foundation” from “Dependency-Track app”; internal-only ingress requirement captured; wildcard cert constraint clarified (`*.logiki.co.uk` does **not** cover `*.apps.logiki.co.uk`) | Foundation ingress deploys first; DTrack goes behind it later |
| v4–v5 | GHES action resolution + vars defaults + YAML syntax | GHES errors resolving `azure/login@v2`, `azure/setup-helm@v4`, `azure/setup-kubectl@v4`; workflow YAML syntax error around DNS step | “Option B”: rely on runner-installed `az/kubectl/helm`; moved operational inputs to `vars.*` with input overrides; fixed YAML structure/indentation; constrained environment selection direction | Workflow becomes GHES-compatible and cleaner to run |
| v6–v7 | Traefik chart schema + timeout + chart-vs-image | Chart schema failures: `imagePullSecrets not allowed`; `ports.*.expose` type mismatch; Helm timeout `"10"` missing unit; confusion between `traefik/traefik` vs `library/traefik` | Adjusted values template to match chart schema; added timeout normalisation; enforced chart source `traefik/traefik` and Nexus image override `library/traefik` | Removed schema/timeout blockers; clarified Nexus-only image sourcing |
| v8 | Gateway selector label type | Gateway API validation: `matchLabels.<key> ... must be of type string: "boolean"` | Forced selector values to strings (quoted / `--set-string`); guarded against boolean-like values | Gateway manifest validation stabilised |
| v9–v10 | Non-interactive auth + Entra-enabled AKS + DNS perms docs | Azure CLI prompted device code login; kubectl steps hung; DNS update in other subscription failed due to perms | Added SPN-based non-interactive login pattern; added `kubelogin convert-kubeconfig -l spn`; documented cross-subscription DNS permissions and required subscription id var | Eliminated interactive login path; clarified permission requirements |
| v11–v12 | Workflow syntax rewrite + dashboard check redesign | Workflow had syntax errors; kube-apiserver proxy/port-forward tests unreliable (`NotFound`, RBAC/proxy issues, connection refused) | Rewrote workflow cleanly; moved dashboard/API test to an **in-cluster Job** hitting a **ClusterIP** dashboard service; added debug toggle to upload generated values (assuming artifact action available) | Reduced runner networking/RBAC fragility; improved diagnostics |
| v13 | Helm render failure in Gateway template | Helm error: `traefik/templates/gateway.yaml ... error calling eq: incompatible types for comparison` | Disabled chart-managed Gateway rendering; apply `GatewayClass/Gateway` via `kubectl` in a separate step when Gateway mode enabled | Avoids chart template bug while keeping Gateway API mode |
| v14 | Bash heredoc expansion + unsuitable test image | `u: unbound variable` in runner script under `set -u`; test image lacked curl/wget | Escaped `\${u}` in heredoc so runner doesn’t expand it; documented `TRAEFIK_TEST_IMAGE` must include curl/wget and be Nexus-hosted | Dashboard test script stops failing at runner expansion stage |
| v15 | Traefik API reachable but returned 404 | In-cluster check: `/api/version` returned `404` | Explicitly enabled API/dashboard via `additionalArguments` (`--api=true`, `--api.dashboard=true`, `--api.insecure=true` internal-only); adjusted check to accept correct response patterns | API endpoint becomes available on internal dashboard service; check aligns with real behaviour |
| v1.0.4 | TLS default + HTTP→HTTPS redirect policy | Need consistent HTTPS default; HTTP-only routes would be broken once redirect is enabled | Set `enable_tls` default to `true`; enforced entryPoint redirect (`web` → `websecure`) when TLS enabled; updated BOM/prompt/onboarding docs to reflect Option B | TLS is the default stance; apps using Ingress must define `spec.tls` in their namespaces to avoid redirect-to-404/cert mismatch |
| v1.0.5 | TLS secret creation failed due to non-PEM secret contents | `tls: failed to find any PEM data in certificate input` then `no objects passed to apply` | Added fast-fail validations: PEM marker checks, `openssl` parse, keypair match; create Secret YAML to file then `kubectl apply` to avoid pipeline masking root error; documented local validation commands in `README.md` | Clearer diagnostics; prevents silent/secondary errors when secrets are base64/PFX/DER or mismatched key |

## Cross-cutting fixes captured during the run
| Area | Symptom | Resolution |
|---|---|---|
| AKS internal load balancer (ILB) provisioning | 403 on subnet read (`Microsoft.Network/virtualNetworks/subnets/read`) during Service LB reconciliation | Granted **Network Contributor** to the AKS managed identity over the node subnet/VNet scope |
| Private DNS in a different subscription | DNS record create/update failed (permissions boundary) | Documented requirement: contributor rights over the Private DNS zone RG in the DNS subscription; `PRIVATE_DNS_ZONE_SUBSCRIPTION_ID` required |
| Nexus-only image policy | Need to ensure all runtime images come from Nexus | Enforced chart from upstream, images overridden to Nexus (e.g. `library/traefik`) and imagePullSecrets creation |
| Idempotent re-runs | Re-run safety | Namespace/secret creation implemented via “create if absent” / `kubectl apply` patterns; Helm uses `--wait --atomic --timeout` |
